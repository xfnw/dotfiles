; prefer nixpkgs-provided asdf if it exists
(let ((asdf (sb-ext:posix-getenv "ASDF")))
  (if asdf
    (load asdf)
    (require 'asdf)))

#-quicklisp
(when (not (sb-ext:posix-getenv "CL_SOURCE_REGISTRY"))
  (let ((quicklisp-init (merge-pathnames "quicklisp/setup.lisp"
                                         (user-homedir-pathname))))
    (when (probe-file quicklisp-init)
      (load quicklisp-init))))

(require 'sb-posix)
(defmacro save-lisp-and-fork (&rest args)
  "save-lisp-and-die but fork first"
  `(let ((res (sb-posix:fork)))
    (case res
      (-1 (error "oh noes"))
      (0 (sb-ext:save-lisp-and-die ,@args))
      (otherwise (sb-posix:wait)))))
