; prefer nixpkgs-provided asdf if it exists
(let ((asdf (sb-ext:posix-getenv "ASDF")))
  (if asdf
    (load asdf)
    (require 'asdf)))

; cursed automatic loading of withPackages stuff
(let ((reg (sb-ext:posix-getenv "CL_SOURCE_REGISTRY")))
  (mapc
    (lambda (x) (asdf:load-system (subseq x 0 (- (length x) 4))))
    (mapcar
      'file-namestring
      (mapcan
	(lambda (x) (when (> (length x) 0)
		      (directory (uiop:strcat x "**/*.asd"))))
	(uiop:split-string reg :separator ":")))))
